apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "caracal.fullname" . }}-config
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "caracal.labels" . | nindent 4 }}
data:
  # Database Configuration
  DB_HOST: {{ include "caracal.postgresql.host" . | quote }}
  DB_PORT: {{ .Values.postgresql.service.port | quote }}
  DB_NAME: {{ .Values.postgresql.auth.database | quote }}
  DB_USER: {{ .Values.postgresql.auth.username | quote }}
  
  # Redis Configuration
  REDIS_HOST: {{ include "caracal.redis.host" . | quote }}
  REDIS_PORT: {{ .Values.redis.service.port | quote }}
  REDIS_DB: "0"
  REDIS_SSL: "false"
  REDIS_SPENDING_CACHE_TTL: "86400"
  REDIS_METRICS_CACHE_TTL: "3600"
  
  # Kafka Configuration
  KAFKA_BOOTSTRAP_SERVERS: {{ include "caracal.kafka.bootstrapServers" . | quote }}
  KAFKA_SECURITY_PROTOCOL: "PLAINTEXT"
  KAFKA_AUTO_OFFSET_RESET: "earliest"
  KAFKA_ENABLE_AUTO_COMMIT: "false"
  KAFKA_ISOLATION_LEVEL: "read_committed"
  KAFKA_MAX_POLL_RECORDS: "500"
  KAFKA_SESSION_TIMEOUT_MS: "30000"
  KAFKA_ENABLE_IDEMPOTENCE: "true"
  KAFKA_ACKS: "all"
  KAFKA_MAX_IN_FLIGHT_REQUESTS: "5"
  
  # Schema Registry
  SCHEMA_REGISTRY_URL: {{ include "caracal.schemaRegistry.url" . | quote }}
  
  # Merkle Tree Configuration
  MERKLE_BATCH_SIZE_LIMIT: {{ .Values.consumers.ledgerWriter.merkle.batchSizeLimit | quote }}
  MERKLE_BATCH_TIMEOUT_SECONDS: {{ .Values.consumers.ledgerWriter.merkle.batchTimeoutSeconds | quote }}
  MERKLE_SIGNING_ALGORITHM: {{ .Values.consumers.ledgerWriter.merkle.signingAlgorithm | quote }}
  MERKLE_SIGNING_KEY_PATH: "/etc/caracal/keys/merkle_signing_key.pem"
  
  # Gateway Configuration
  GATEWAY_LISTEN_ADDRESS: "0.0.0.0:{{ .Values.gateway.service.httpsPort }}"
  AUTH_MODE: {{ .Values.gateway.authMode | quote }}
  LOG_LEVEL: {{ .Values.logging.level | quote }}
  REQUEST_TIMEOUT: "30"
  MAX_REQUEST_SIZE_MB: "10"
  
  # TLS Configuration
  TLS_CERT_FILE: "/etc/caracal/tls/server.crt"
  TLS_KEY_FILE: "/etc/caracal/tls/server.key"
  TLS_CA_FILE: "/etc/caracal/tls/ca.crt"
  JWT_PUBLIC_KEY_PATH: "/etc/caracal/tls/jwt_public.pem"
  JWT_ALGORITHM: "RS256"
  
  # Replay Protection
  ENABLE_REPLAY_PROTECTION: {{ .Values.gateway.replayProtection.enabled | quote }}
  NONCE_CACHE_TTL: {{ .Values.gateway.replayProtection.nonceCacheTTL | quote }}
  NONCE_CACHE_SIZE: {{ .Values.gateway.replayProtection.nonceCacheSize | quote }}
  TIMESTAMP_WINDOW: {{ .Values.gateway.replayProtection.timestampWindow | quote }}
  
  # Policy Cache
  ENABLE_POLICY_CACHE: {{ .Values.gateway.policyCache.enabled | quote }}
  POLICY_CACHE_TTL: {{ .Values.gateway.policyCache.ttl | quote }}
  POLICY_CACHE_MAX_SIZE: {{ .Values.gateway.policyCache.maxSize | quote }}
  
  # Provisional Charges
  PROVISIONAL_CHARGE_EXPIRATION: {{ .Values.gateway.provisionalCharges.expiration | quote }}
  PROVISIONAL_CHARGE_MAX_TIMEOUT: {{ .Values.gateway.provisionalCharges.maxTimeout | quote }}
  PROVISIONAL_CHARGE_CLEANUP_INTERVAL: {{ .Values.gateway.provisionalCharges.cleanupInterval | quote }}
  PROVISIONAL_CHARGE_CLEANUP_BATCH_SIZE: {{ .Values.gateway.provisionalCharges.cleanupBatchSize | quote }}
  
  # MCP Adapter Configuration
  MCP_ADAPTER_LISTEN_ADDRESS: "0.0.0.0:{{ .Values.mcpAdapter.service.port }}"
  MCP_SERVERS: {{ .Values.mcpAdapter.mcpServers | quote }}
  MCP_SERVER_TIMEOUT: {{ .Values.mcpAdapter.mcpServerTimeout | quote }}
  
  # Consumer Configuration
  METRICS_PORT: {{ .Values.consumers.metricsAggregator.metricsPort | quote }}
  ANOMALY_DETECTION_THRESHOLD: {{ .Values.consumers.metricsAggregator.anomalyDetectionThreshold | quote }}
  AUDIT_LOG_RETENTION_DAYS: {{ .Values.consumers.auditLogger.auditLogRetentionDays | quote }}
  
  # Monitoring Configuration
  ENABLE_PROMETHEUS_METRICS: {{ .Values.monitoring.prometheus.enabled | quote }}
  ENABLE_STRUCTURED_LOGGING: {{ .Values.logging.structuredLogging | quote }}
